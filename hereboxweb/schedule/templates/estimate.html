{% extends "base.html" %}
{% block content %}

    <div class="container" style="width: 680px;">
        <div style="margin: 40px 0 40px; text-align: center;">
            <img src="{{ url_for('static', filename='assets/img/5step_1.png') }}">
        </div>

        <div class="row">
            <div class="estimate-title" style="margin-top: 80px;">무엇을 보관하실 건가요?</div>
            <div class="estimate-goods-items">
                <div class="estimate-goods-items-row">
                    <div id="regularItem" class="item">
                        <div class="item-box">
                            <img src="{{ url_for('static', filename='assets/img/img-box.png') }}">
                            <h2>규격박스</h2>
                            <p>
                                튼튼한 플라스틱 박스로 안전합니다
                                <br>
                                가로 60cm x 세로 40cm x 높이 37cm
                                <br>
                                최대 무게 25kg
                                <br><br>
                                <a style="color: #ffa000;">박스 크기 영상으로 보기 ></a>
                            </p>

                            <p class="price">
                                7,500원 / 월
                            </p>
                        </div>

                        <div class="count" style="margin: 20px auto 0;">
                            <div class="count-row">
                                <div class="count-item subtract">-</div>
                                <div class="count-item number" style="color: #ffc107;">0</div>
                                <div class="count-item add">+</div>
                            </div>
                        </div>
                    </div>

                    <div id="irregularItem" class="item">
                        <div class="item-box">
                            <img src="{{ url_for('static', filename='assets/img/img-un.png') }}">
                            <h2>비규격 물품</h2>
                            <p>
                                박스에 들어가지않는 큰 물건도 걱정마세요
                                <br>
                                자전거, 캐리어, 골프백, 스키 등 한 명이 옮길
                                <br>
                                수 있는 물품이라면 가능합니다
                                <br><br>
                            </p>

                            <br>

                            <p class="price">
                                9,900원 / 월
                            </p>
                        </div>

                        <div class="count" style="margin: 20px auto 0;">
                            <div class="count-row">
                                <div class="count-item subtract">-</div>
                                <div class="count-item number" style="color: #ffc107;">0</div>
                                <div class="count-item add">+</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row" style="margin-top: 80px;">
            <div id="disposable" class="col-xs-6 estimate-title">
                <div>몇 개월간 보관하실 건가요?</div>
                <div id="optionsPeriod" class="radio">
                    <label>
                        <input type="radio" name="optionsPeriod" id="optionsDisposable" value="disposable" checked>
                        기간 설정
                        <p class="estimate-month-item-desc">
                            설정한 기간만큼만 보관료를 결제합니다<br>
                            * 기간 만료 시 직접 연장 필요
                        </p>
                        <div class="count" style="margin: 20px 0;">
                            <div class="count-row">
                                <div class="count-item subtract">-</div>
                                <div class="count-item number" style="color: #ffc107;">0</div>
                                <div class="count-item add">+</div>
                            </div>
                        </div>
                    </label>
                    <label>
                        <input type="radio" name="optionsPeriod" id="optionsSubscription" value="subscription" disabled>
                        자동 결제 (준비 중)
                        <p class="estimate-month-item-desc">
                            매 달 자동으로 보관료가 결제됩니다
                        </p>
                    </label>
                </div>
            </div>
            <div class="col-xs-6 estimate-title">
                <div>필요한 포장 용품을 구매하세요</div>
                <div style="font-size: 14px; color: #ffa000; cursor: pointer;" data-toggle="modal" data-target="#bindingProductManual">포장 용품 자세히 알아보기 ></div>
                <div class="binding-product-item">
                    <div id="bindingProduct0" class="row" style="margin: 12px -5px 12px;">
                        <div class="col-xs-6" style="padding-right: 5px">
                            포장용 에어캡 1m<br>
                            500원 / 개
                        </div>
                        <div class="col-xs-6">
                            <div class="count">
                                <div class="count-row">
                                    <div class="count-item subtract">-</div>
                                    <div class="count-item number" style="color: #ffc107;">0</div>
                                    <div class="count-item add">+</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="bindingProduct1" class="row" style="margin: 12px -5px 12px;">
                        <div class="col-xs-6" style="padding-right: 5px">
                            실리카겔 (제습제) 50g<br>
                            500원 / 개
                        </div>
                        <div class="col-xs-6">
                            <div class="count">
                                <div class="count-row">
                                    <div class="count-item subtract">-</div>
                                    <div class="count-item number" style="color: #ffc107;">0</div>
                                    <div class="count-item add">+</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="bindingProduct2" class="row" style="margin: 12px -5px 12px;">
                        <div class="col-xs-6" style="padding-right: 5px">
                            압축팩 40cm x 60cm<br>
                            1,500원 / 개
                        </div>
                        <div class="col-xs-6">
                            <div class="count">
                                <div class="count-row">
                                    <div class="count-item subtract">-</div>
                                    <div class="count-item number" style="color: #ffc107;">0</div>
                                    <div class="count-item add">+</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="bindingProduct3" class="row" style="margin: 12px -5px 12px;">
                        <div class="col-xs-6" style="padding-right: 5px">
                            테이프 48mm x 40m<br>
                            1,000원 / 개
                        </div>
                        <div class="col-xs-6 ">
                            <div class="count">
                                <div class="count-row">
                                    <div class="count-item subtract">-</div>
                                    <div class="count-item number" style="color: #ffc107;">0</div>
                                    <div class="count-item add">+</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row vertical-align" style="margin-top: 80px;">
            <div class="col-xs-6">
                <div style="white-space: nowrap;">
                    <img src="{{ url_for('static', filename='assets/img/icon-promo.png') }}">
                    <div style="margin-left: 16px; display: inline-block; vertical-align: top;">
                        <div style="font-family: 'Nanum Barun Gothic Light', sans-serif; font-size: 20px; color: #212121;">프로모션 코드</div>
                        <div style="font-family: 'Nanum Barun Gothic Light', sans-serif; font-size: 14px; color: #212121;">
                            프로모션 코드를 가지고 계시다면 입력해주세요<br>
                            할인 혜택을 받을 수 있습니다
                            <p>
                                <a style="color: #ffa000; cursor: pointer;" href="/event" target="_blank">진행 중인 이벤트 확인하기 ></a>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xs-6">
                <div class="col-xs-8" style="padding-right: 5px;">
                    <input type="text" class="form-control" id="inputPromotion" placeholder="프로모션 코드를 입력하세요">
                </div>
                <button id="btnCheckPromotion" type="button" class="col-xs-2 btn btn-hbprimary" style="font-size: 14px; padding: 9px 4px;">확인</button>
            </div>
        </div>

        <div style="margin-top: 80px; font-family: 'Nanum Barun Gothic Light', sans-serif; font-size: 20px; color: #212121; text-align: center;">
            예상 결제 비용
            <div>
                <div id="totalPrice" style="display: inline-block; margin: 10px 0; padding: 15px 120px; font-family: 'Nanum Barun Gothic Bold', sans-serif; font-size: 26px; color: #ffc107; border-radius: 4px; background-color: #ffffff; border: solid 1px #ffc107;">
                    0
                </div>
            </div>

            <div style="font-size: 14px; color: #727272;">
                총 보관 비용 : <span id="totalStoragePrice"></span><br>
                포장 용품 비용 : <span id="totalBindingProductPrice"></span><br>
                <span id="promotionDiscount" style="visibility: hidden;"></span><br>

                <br>
                <p><a style="font-size: 14px; color: #ffa000; cursor: pointer;" data-toggle="modal" data-target="#discountManual">할인 정책 알아보기 ></a></p>
            </div>

            <button id="btnNextStep" class="btn btn-hbprimary" style="margin: 80px 0 100px 0;">다음 단계</button>
        </div>
    </div>

    {% include "dialog_dcp.html" %}
    {% include "dialog_binding_product.html" %}

{% endblock %}
{% block jscript %}

    <script src="{{ url_for('static', filename='libs/js-cookie/src/js.cookie.js') }}"></script>
    <script src="{{ url_for('static', filename='assets/js/herebox.js') }}"></script>
    <script src="{{ url_for('static', filename='assets/js/hbcounter.js') }}"></script>
    <script src="{{ url_for('static', filename='libs/numeral/min/numeral.min.js') }}"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='libs/moment/min/moment.min.js') }}"></script>

    <script>
        var allowUnload = false;
        $(document).ready(function() {
            allowUnload = false;

            $(window).on('beforeunload', function() {
                if (allowUnload) {
                    return ;
                } else {
                    return '현재 입력된 항목들이 지워집니다! 정말 예약을 취소하시겠습니까?';
                }
            });
            $(window).on('unload', function() {
                if (!allowUnload) {
                    purchaseCookieClear();
                }
            });

            var estimateInfo = Cookies.get('estimate');
            if (estimateInfo)
                estimateInfo = $.parseJSON(decode_cookie(estimateInfo));

            var regularItem = $('#regularItem');
            var regularItemSubtract = regularItem.find('.subtract');
            var regularItemNumber = regularItem.find('.number');
            if (estimateInfo && estimateInfo['regularItemNumberCount']) {
                var oldRegularItemNumberCount = estimateInfo['regularItemNumberCount'];
                regularItemNumber.text(oldRegularItemNumberCount);
            }

            var regularItemAdd = regularItem.find('.add');
            var irregularItem = $('#irregularItem');
            var irregularItemSubtract = irregularItem.find('.subtract');
            var irregularItemNumber = irregularItem.find('.number');
            if (estimateInfo && estimateInfo['irregularItemNumberCount']) {
                var oldIrregularItemNumberCount = estimateInfo['irregularItemNumberCount'];
                irregularItemNumber.text(oldIrregularItemNumberCount);
            }

            var irregularItemAdd = irregularItem.find('.add');
            var disposable = $('#disposable');
            var disposableSubtract = disposable.find('.subtract');
            var disposableNumber = disposable.find('.number');
            if (estimateInfo && estimateInfo['disposableNumberCount']) {
                var oldDisposableNumberCount = estimateInfo['disposableNumberCount'];
                disposableNumber.text(oldDisposableNumberCount);
            }

            var disposableAdd = disposable.find('.add');
            var bindingProduct0 = $('#bindingProduct0');
            var bindingProduct0Subtract = bindingProduct0.find('.subtract');
            var bindingProduct0Number = bindingProduct0.find('.number');
            if (estimateInfo && estimateInfo['bindingProduct0NumberCount']) {
                var oldBindingProduct0NumberCount = estimateInfo['bindingProduct0NumberCount'];
                bindingProduct0Number.text(oldBindingProduct0NumberCount);
            }

            var bindingProduct0Add = bindingProduct0.find('.add');
            var bindingProduct1 = $('#bindingProduct1');
            var bindingProduct1Subtract = bindingProduct1.find('.subtract');
            var bindingProduct1Number = bindingProduct1.find('.number');
            if (estimateInfo && estimateInfo['bindingProduct1NumberCount']) {
                var oldBindingProduct1NumberCount = estimateInfo['bindingProduct1NumberCount'];
                bindingProduct1Number.text(oldBindingProduct1NumberCount);
            }

            var bindingProduct1Add = bindingProduct1.find('.add');
            var bindingProduct2 = $('#bindingProduct2');
            var bindingProduct2Subtract = bindingProduct2.find('.subtract');
            var bindingProduct2Number = bindingProduct2.find('.number');
            if (estimateInfo && estimateInfo['bindingProduct2NumberCount']) {
                var oldBindingProduct2NumberCount = estimateInfo['bindingProduct2NumberCount'];
                bindingProduct2Number.text(oldBindingProduct2NumberCount);
            }

            var bindingProduct2Add = bindingProduct2.find('.add');
            var bindingProduct3 = $('#bindingProduct3');
            var bindingProduct3Subtract = bindingProduct3.find('.subtract');
            var bindingProduct3Number = bindingProduct3.find('.number');
            if (estimateInfo && estimateInfo['bindingProduct3NumberCount']) {
                var oldBindingProduct3NumberCount = estimateInfo['bindingProduct3NumberCount'];
                bindingProduct3Number.text(oldBindingProduct3NumberCount);
            }

            var bindingProduct3Add = bindingProduct3.find('.add');

            if (estimateInfo && estimateInfo['optionsPeriod']) {
                var oldOptionsPeriod = estimateInfo['optionsPeriod'];
                switch (oldOptionsPeriod) {
                    case 'disposable':
                        $("input:radio[id='optionsDisposable']").attr("checked", true);
                        $("input:radio[id='optionsSubscription']").attr("checked", false);
                        break;
                    case 'subscription':
                        $("input:radio[id='optionsSubscription']").attr("checked", true);
                        $("input:radio[id='optionsDisposable']").attr("checked", false);
                        break;
                }
            }

            var calculateStoragePrice = function() {
                var totalStoragePrice = 0;
                var regularItemNumberCount = Number(regularItemNumber.text());
                var irregularItemNumberCount = Number(irregularItemNumber.text());
                var disposableNumberCount = Number(disposableNumber.text());

                if ($(":radio[name='optionsPeriod']:checked").val() == 'disposable') {
                    totalStoragePrice = totalStoragePrice + (7500 * regularItemNumberCount * disposableNumberCount);
                    totalStoragePrice = totalStoragePrice + (9900 * irregularItemNumberCount * disposableNumberCount);
                } else {
                    totalStoragePrice = totalStoragePrice + (7500 * regularItemNumberCount);
                    totalStoragePrice = totalStoragePrice + (9900 * irregularItemNumberCount);
                }

                $('#totalStoragePrice').text(numeral(totalStoragePrice).format('0,0'));
                return totalStoragePrice;
            };

            var calculateBindingProductPrice = function() {
                var totalBindingProductPrice = 0;
                var bindingProduct0NumberCount = Number(bindingProduct0Number.text());
                var bindingProduct1NumberCount = Number(bindingProduct1Number.text());
                var bindingProduct2NumberCount = Number(bindingProduct2Number.text());
                var bindingProduct3NumberCount = Number(bindingProduct3Number.text());

                totalBindingProductPrice = totalBindingProductPrice + 500 * bindingProduct0NumberCount;
                totalBindingProductPrice = totalBindingProductPrice + 500 * bindingProduct1NumberCount;
                totalBindingProductPrice = totalBindingProductPrice + 1500 * bindingProduct2NumberCount;
                totalBindingProductPrice = totalBindingProductPrice + 1000 * bindingProduct3NumberCount;

                $('#totalBindingProductPrice').text(numeral(totalBindingProductPrice).format('0,0'));
                return totalBindingProductPrice;
            };

            var changeTotalPrice = function(direction, count) {
                if (Cookies.get('promotion') && Cookies.get('promotion') == 'HELLOHB') {
                    applyHELLOHBPromotion();
                } else {
                    var totalPrice = calculateStoragePrice() + calculateBindingProductPrice();
                    if (totalPrice < 0) {
                        totalPrice = 0;
                    }
                    $('#totalPrice').text(numeral(totalPrice).format('0,0'));
                }
            };

            changeTotalPrice();

            var regularItemHbCounter = new HereboxCounter(regularItemSubtract, regularItemAdd, regularItemNumber,
                changeTotalPrice
            );
            var irregularItemHbCounter = new HereboxCounter(irregularItemSubtract, irregularItemAdd, irregularItemNumber,
                changeTotalPrice
            );
            var disposableHbCounter = new HereboxCounter(disposableSubtract, disposableAdd, disposableNumber,
                changeTotalPrice
            );
            var bindingProduct0HbCounter = new HereboxCounter(bindingProduct0Subtract, bindingProduct0Add, bindingProduct0Number,
                changeTotalPrice
            );
            var bindingProduct1HbCounter = new HereboxCounter(bindingProduct1Subtract, bindingProduct1Add, bindingProduct1Number,
                changeTotalPrice
            );
            var bindingProduct2HbCounter = new HereboxCounter(bindingProduct2Subtract, bindingProduct2Add, bindingProduct2Number,
                changeTotalPrice
            );
            var bindingProduct3HbCounter = new HereboxCounter(bindingProduct3Subtract, bindingProduct3Add, bindingProduct3Number,
                changeTotalPrice
            );

            $('input[type=radio][name=optionsPeriod]').change(function() {
                changeTotalPrice();
            });

            $('#btnCheckPromotion').click(function() {
                $.ajax({
                    type: "GET",
                    url: "/promotion/" + $('#inputPromotion').val(),
                    success: function () {
                        alert("프로모션 코드가 확인되었습니다");
                        if ("HELLOHB" === $('#inputPromotion').val()) {
                            applyHELLOHBPromotion();
                        }
                    },
                    error: function(request, status, error) {
                        var parsedBody = $.parseJSON(request.responseText);
                        alert(parsedBody['message']);
                    }
                });
            });

            $('#btnNextStep').click(function() {
                if (calculateStoragePrice() == 0) {
                    alert("규격박스 또는 비규격 물품을 1개월 이상 주문해주셔야 합니다!");
                    return ;
                }

                allowUnload = true;

                var regularItemNumberCount = regularItemNumber.text();
                var irregularItemNumberCount = irregularItemNumber.text();
                var disposableNumberCount = disposableNumber.text();
                var optionsPeriod = $(":radio[name='optionsPeriod']:checked").val();
                var bindingProduct0NumberCount = bindingProduct0Number.text();
                var bindingProduct1NumberCount = bindingProduct1Number.text();
                var bindingProduct2NumberCount = bindingProduct2Number.text();
                var bindingProduct3NumberCount = bindingProduct3Number.text();
                var totalPrice = calculateStoragePrice() + calculateBindingProductPrice();
                var promotion = $('#inputPromotion').val();

                $.ajax({
                     type: "POST",
                     url: "/reservation/order",
                     data: {regularItemNumberCount: regularItemNumberCount,
                         irregularItemNumberCount: irregularItemNumberCount, disposableNumberCount: disposableNumberCount,
                         optionsPeriod: optionsPeriod, bindingProduct0NumberCount: bindingProduct0NumberCount,
                         bindingProduct1NumberCount: bindingProduct1NumberCount, bindingProduct2NumberCount: bindingProduct2NumberCount,
                         bindingProduct3NumberCount: bindingProduct3NumberCount, totalPrice: totalPrice, inputPromotion: promotion
                     },
                     success: function () {
                        location.href = '/reservation/order';
                     },
                     error: function(request, status, error) {
                        var parsedBody = $.parseJSON(request.responseText);
                        alert(parsedBody['message']);
                     }
                });
            });

            function applyHELLOHBPromotion() {
                if ($(":radio[name='optionsPeriod']:checked").val() == 'disposable') {
                    var totalStoragePrice = 0;
                    var totalPrice = calculateBindingProductPrice();
                    var regularItemNumberCount = Number(regularItemNumber.text());
                    var irregularItemNumberCount = Number(irregularItemNumber.text());
                    var disposableNumberCount = Number(disposableNumber.text());
                    var promotionItem = '프로모션 할인: ';
                    var discountCount = 10;
                    discountCount -= irregularItemNumberCount;
                    if (discountCount >= 0) {
                        totalStoragePrice = totalStoragePrice + (9900 * irregularItemNumberCount * (disposableNumberCount - 1));
                    } else {
                        totalStoragePrice = totalStoragePrice + (9900 * 10 * (disposableNumberCount - 1));
                        totalStoragePrice = totalStoragePrice + (9900 * (discountCount * -1) * disposableNumberCount);
                    }

                    if (discountCount > 0) {
                        regularItemNumberCount -= discountCount;
                        totalStoragePrice = totalStoragePrice + (7500 * discountCount * (disposableNumberCount - 1));
                        totalStoragePrice = totalStoragePrice + (7500 * regularItemNumberCount * disposableNumberCount);
                    } else {
                        totalStoragePrice = totalStoragePrice + (7500 * regularItemNumberCount * disposableNumberCount);
                    }

                    totalPrice = totalStoragePrice + totalPrice;
                    if (totalPrice < 0) {
                        totalPrice = 0;
                    }

                    $('#totalStoragePrice').text(numeral(totalStoragePrice).format('0,0'));
                    $('#promotionDiscount').text(promotionItem + "-" + numeral(calculateStoragePrice() - totalStoragePrice).format('0,0'));
                    $('#promotionDiscount').css({'visibility': 'visible'});
                    $('#totalPrice').text(numeral(totalPrice).format('0,0'));
                }
            }
        });
    </script>

{% endblock %}