{% extends "base.html" %}
{% block content %}

    <div class="container" style="width: 960px;">
        <div style="margin: 40px 0 40px; text-align: center;">
            <img src="{{ url_for('static', filename='assets/img/4-step-2-1.png') }}">
        </div>

        <div class="row">
            <div class="estimate-title" style="margin-top: 80px;">기간 연장할 물품 ({{ packed_stuffs | length }})</div>

            <div class="my-stuff-items">
                <div class="my-stuff-items-row">

                    {% for my_stuff in packed_stuffs %}
                        {% if loop.index % 3 == 1 %}
                            </div>
                            <div class="my-stuff-items-row">
                        {% endif %}

                        <div class="item">
                            <div class="item-box" style="height: 370px;">
                                <img src="{{ url_for('static', filename='assets/img/img-box.png') }}">
                                <h2>{{ my_stuff.name }}</h2>
                                <p style="margin-top: 20px;">
                                    관리번호: <span id="goods_id">{{ my_stuff.goods_id }}</span>
                                    <br>
                                    보관기간: {{ my_stuff.created_at.strftime('%Y-%m-%d') }} ~ {{ my_stuff.expired_at }}
                                    <br>
                                    만료일까지 {{ my_stuff.remaining_day }}일 남았습니다
                                    <br><br>
                                </p>
                            </div>

                            <div style="margin-top: 10px; display: flex; justify-content: center;">
                                <span style="margin-right: 10px;align-self: center; font-family: 'Nanum Barun Gothic Light', sans-serif; font-size: 14px; color: #212121;">몇 개월 연장하실 건가요?</span>
                                <div class="count" style="align-self: center;">
                                    <div class="count-row">
                                        <div class="count-item subtract">-</div>
                                        <div id="period" class="count-item number" style="color: #ffc107;">2</div>
                                        <div class="count-item add">+</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="row vertical-align" style="margin-top: 80px;">
            <div class="col-xs-6">
                <div style="white-space: nowrap;">
                    <img src="{{ url_for('static', filename='assets/img/icon-promo.png') }}">
                    <div style="margin-left: 16px; display: inline-block; vertical-align: top;">
                        <div style="font-family: 'Nanum Barun Gothic Light', sans-serif; font-size: 20px; color: #212121;">프로모션 코드</div>
                        <div style="font-family: 'Nanum Barun Gothic Light', sans-serif; font-size: 14px; color: #212121;">
                            프로모션 코드를 가지고 계시다면 입력해주세요<br>
                            할인 혜택을 받을 수 있습니다
                            <p style="color: #ffa000;">
                                진행 중인 이벤트 확인하기 >
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xs-6">
                <div class="col-xs-6">
                    <input type="text" class="form-control" id="inputPromotion" placeholder="프로모션 코드를 입력하세요">
                </div>
                <button id="btnCheckPromotion" type="button" class="col-xs-2 btn btn-hbprimary" style="font-size: 14px; padding: 9px 4px;">확인</button>
            </div>
        </div>

        <div style="margin-top: 80px; font-family: 'Nanum Barun Gothic Light', sans-serif; font-size: 20px; color: #212121; text-align: center;">
            예상 결제 비용
            <div>
                <div id="totalPrice" style="display: inline-block; margin: 10px 0; padding: 15px 120px; font-family: 'Nanum Barun Gothic Bold', sans-serif; font-size: 26px; color: #ffc107; border-radius: 4px; background-color: #ffffff; border: solid 1px #ffc107;">
                    0
                </div>
            </div>

            <div style="font-size: 14px; color: #727272;">
                총 보관 비용 : <span id="totalStoragePrice"></span><br>
                포장 용품 비용 : <span id="totalBindingProductPrice"></span><br>

                <br>
                <p style="font-size: 14px; color: #ffa000; cursor: pointer;" data-toggle="modal" data-target="#discountManual">할인 정책 알아보기 ></p>
            </div>

            <button id="btnNextStep" onclick="location.href='/extended/review';" class="btn btn-hbprimary" style="margin: 80px 0 100px 0;">다음 단계</button>
        </div>
    </div>

    <div id="discountManual" class="modal fade" role="dialog">
    <div class="modal-dialog">

    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">할인 정책이 궁금하세요?</h4>
      </div>
      <div class="modal-body">
        <p>히어박스는 보관 기간에 따른 할인율을 적용하고 있습니다. (자동결제 제외)</p>
        <p>
            6 ~ 8개월 : 총 보관 비용의 5% 할인
            <br>9 ~ 11개월 : 총 보관 비용의 7% 할인
            <br>12개월 이상 : 총 보관 비용의 10% 할인
        </p>
          <p>
              그 외에도 다양한 이벤트를 통해 할인 혜택을 받으실 수 있습니다.
              <br><a style="font-size: 14px; color: #ffa000;">진행 중인 이벤트 확인하기   ></a>
          </p>
      </div>
    </div>

    </div>
    </div>

{% endblock %}
{% block jscript %}

    <script src="{{ url_for('static', filename='libs/js-cookie/src/js.cookie.js') }}"></script>
    <script src="{{ url_for('static', filename='assets/js/herebox.js') }}"></script>
    <script src="{{ url_for('static', filename='assets/js/hbcounter.js') }}"></script>
    <script src="{{ url_for('static', filename='libs/numeral/min/numeral.min.js') }}"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='libs/moment/min/moment.min.js') }}"></script>

    <script>
        var allowUnload = false;
        $(document).ready(function() {
            allowUnload = false;

            $(window).on('beforeunload', function() {
                if (allowUnload) {
                    return ;
                } else {
                    return '현재 입력된 항목들이 지워집니다! 정말 연장을 취소하시겠습니까?';
                }
            });
            $(window).on('unload', function() {
                if (!allowUnload) {
                    purchaseCookieClear();
                }
            });

            var estimateInfo = Cookies.get('estimate');
            if (estimateInfo)
                estimateInfo = $.parseJSON(decode_cookie(estimateInfo));

            var changeTotalPrice = function(direction, count) {
                var totalPrice = 0;

                var stuffs = $(".item");
                stuffs.each(function () {
                    var goodsId = $(this).find(".item-box > p > span#goods_id").text();
                    var currentPrice = 0;
                    var currentPeriod = Number($(this).find('#period').text());
                    if (goodsId.startsWith("A")) {
                        currentPrice = (7500 * currentPeriod);
                    } else {
                        currentPrice = (9900 * currentPeriod);
                    }
                    totalPrice += currentPrice;
                    estimateInfo[goodsId] = currentPeriod;
                });

                if (totalPrice < 0) {
                    totalPrice = 0;
                }
                $('#totalPrice').text(numeral(totalPrice).format('0,0'));
                return totalPrice;
            };

            var stuffs = $(".item");
            stuffs.each(function () {
                new HereboxCounter($(this).find('.subtract'), $(this).find('.add'), $(this).find('.number'),
                    changeTotalPrice
                );

                var goodsId = $(this).find(".item-box > p > span#goods_id").text();

                if (estimateInfo && estimateInfo[goodsId]) {
                    var oldGoodsCount = estimateInfo[goodsId];
                    $(this).find('.number').text(oldGoodsCount);
                }
            });

            var startTime = moment().format('YYYY-MM-DD HH:mm:ss');
            changeTotalPrice();

            $('#btnCheckPromotion').click(function() {
                alert("해당되는 프로모션이 없습니다.");
            });

            $('#btnNextStep').click(function() {
                allowUnload = true;

                $.ajax({
                     type: "POST",
                     url: "/extended/review",
                     data: {estimate: JSON.stringify(estimateInfo), totalPrice: changeTotalPrice(),
                         startTime: startTime
                     },
                     success: function () {
                        location.href = '/extended/review'
                     },
                     error: function(request, status, error) {
                        var parsedBody = $.parseJSON(request.responseText);
                        alert(parsedBody['message']);
                     }
                });
            });
        });
    </script>

{% endblock %}